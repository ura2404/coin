#!/bin/bash

# need
#    export ROOT
#    export JQ
#    export SCREEN

LOG=$ROOT/log/fly.log

# purge log file
#find $ROOT/log -name 'fly.log' -mtime +5 -delete
TRUN=`cat $ROOT/conf/log.json | $JQ '.truncate' | $JQ '.fly' | sed 's/\"//g'`
if [ -e "$ROOT/flg/tr_fly.flg" ]
then
    rm -f $ROOT/flg/tr_fly.flg
    tail $LOG -n $TRUN > $LOG'1'
    mv $LOG'1' $LOG
fi


# --- --- --- --- ---
function make_start(){
    ID=$1
    SID=$2
    EXEC=$3

    INS=`ps aux | grep $SID | grep -v grep`

    if [ -z "$INS" ]
    then
        echo 'Start'
        echo `date +%Y-%m-%d_%H:%M:%S` 'Start' $ID			>> $LOG
        $SCREEN -dmS $SID bash $EXEC
    else
        echo 'Allready started'
    fi

}

function make_stop(){
    ID=$1
    SID=$2

    INS=`ps aux | grep $SID | grep -v grep`

    if [ -n "$INS" ]
    then
        echo 'Stop'
        echo `date +%Y-%m-%d_%H:%M:%S` 'Stop' $ID			>> $LOG
        PID=`echo $INS | awk '{print $2}'`
        kill $PID
    else
        echo 'Allready stoped'
    fi
}

function make_restart(){
    ID=$1
    SID=$2
    EXEC=$3

    echo `date +%Y-%m-%d_%H:%M:%S` 'Restart' $ID			>> $LOG
    make_stop $ID $SID && make_start $ID $SID $EXEC
}

function make_exec(){
    echo '----------------------------------------'
    echo 'Check fly'

    while ((i++)); read fly; do
        ID=`echo $fly | $JQ '.name'  | sed 's/\"//g'`
        echo '----------------------------------------'
        echo $ID

        SID='SCR_COIN_'$i
        EXEC=$ROOT/execs/$i.bash

        ENABLE=`echo $fly | $JQ '.enable'`

        MINER=`echo $fly | $JQ '.miner'`
        MINERA=`cat $ROOT/conf/miners.json | $JQ .$MINER`

        WALLET=`echo $fly | $JQ '.wallet'`
        WALLET=`cat $ROOT/conf/wallets.json | $JQ .$WALLET |  $JQ '.wallet' | sed 's/\"//g'`

        # --- --- --- --- ---
        #echo 'WALLET='$WALLET
        #echo 'MINERA='$MINERA

        if [ "$MINERA" == 'null' ] || [ "$WALLET" == 'null' ];
        then
            make_stop $ID $SID
        else
            MD1=`md5sum $EXEC | awk '{print $1}'`

            echo '#!/bin/bash'								>  $EXEC
            echo 									>> $EXEC
            echo 'cd '$ROOT'/miners/'`echo $MINERA | $JQ '.folder' | sed 's/\"//g'`	>> $EXEC
            echo 									>> $EXEC
            echo 'INDEX='$i								>> $EXEC
            echo 'INI='$ROOT/execs/$i.ini						>> $EXEC
            echo 'NAME='`cat $ROOT/conf/rig.json | $JQ '.name' | sed 's/\"//g'`		>> $EXEC
            echo 'EMAIL='`cat $ROOT/conf/rig.json | $JQ '.email' | sed 's/\"//g'`	>> $EXEC
            echo 'COIN='`echo $fly | $JQ '.coin' | sed 's/\"//g'`			>> $EXEC
            echo 'WALLET='$WALLET							>> $EXEC
            echo 'IP='`echo $fly | $JQ '.ip' | sed 's/\"//g'`				>> $EXEC
            echo 'PORT='`echo $fly | $JQ '.port' | sed 's/\"//g'`			>> $EXEC
            echo 'DEVICES='`echo $fly | $JQ '.devices' | sed 's/\"//g'`			>> $EXEC
            echo 									>> $EXEC

            echo $MINERA | $JQ '.exec' | $JQ -c '.[]' | while read -r rec
            do
                echo $rec  | sed 's/\"//g'						>> $EXEC
            done
            chmod 700 $EXEC

            MD2=`md5sum $EXEC | awk '{print $1}'`

            if [ $ENABLE == 'true' ];
            then
                if [ -e "$ROOT/flg/$ID.restart" ]
                then
                    echo 'Restart by flag'
                    rm -f $ROOT/flg/$ID.restart
                    make_restart $SID $EXEC
                else
                    if [ "$MD1" != "$MD2" ]
                    then
                        echo 'Restart by change fly file'
                        make_restart $ID $SID $EXEC
                    else
                        make_start $ID $SID $EXEC
                    fi
                fi
            else
                make_stop $ID $SID
            fi
        fi

    done
}